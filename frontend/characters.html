<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>互动小说系统 · 角色管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="assets/css/style.css">
  <script>
    (function() {
      // 1. 读取本地存储的主题 (如果没有则默认 dark)
      const savedTheme = localStorage.getItem('app_theme') || 'dark';
      const savedBg = localStorage.getItem('app_bg') || 'grid';

      // 2. 立即应用到 html 标签 (控制颜色变量)
      document.documentElement.setAttribute('data-theme', savedTheme);

      // 3. 应用背景纹理 (控制 body class)
      // 注意：这里需要等待 DOM 解析，或者直接操作 document.write (不推荐)
      // 最稳妥的方式是监听 DOMContentLoaded，或者放在 body 开始标签后。
      // 但为了防止闪烁，我们尝试直接在 head 里预设一个 style
      window.addEventListener('DOMContentLoaded', () => {
         // 清除所有旧的 bg- 开头的类
         document.body.className = document.body.className.replace(/\bbg-\S+/g, '').trim();
         // 添加新的背景类
         document.body.classList.add('bg-' + savedBg);
      });
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>
<body data-page="characters">
  <header class="top-nav">
    <div class="nav-left">
      <span class="app-title">互动小说系统</span>
      <span class="app-subtitle">Storyteller MVP · 角色中心</span>
    </div>
    <nav class="nav-links">
      <a href="index.html" class="nav-link">剧情</a>
      <a href="characters.html" class="nav-link active">角色</a>
      <a href="worldbook.html" class="nav-link">世界书</a>
      <a href="dungeon.html" class="nav-link">副本</a>
      <a href="settings.html" class="nav-link">设置</a>
    </nav>
  </header>

  <main class="two-column-layout">
    <section class="left-panel">
      <div class="panel-header">
        <div class="panel-title">角色列表</div>
      </div>

      <div class="settings-section">
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <input type="file" id="character-import-file" accept=".json" style="display: none;">
          <button id="character-import-btn" class="btn-secondary">导入角色 JSON</button>
          <button id="character-export-all-btn" class="btn-secondary">批量导出角色</button>
          <button id="character-new-btn" class="btn-primary" style="flex: 1; min-width: 120px;">新建角色</button>
        </div>
      </div>

      <div class="settings-section" style="border-top: 1px solid var(--border-soft); padding-top: 10px;">
        <label class="form-label">管理角色模板</label>
        <div style="display: flex; gap: 5px; margin-bottom: 8px;">
            <select id="template-select" class="form-select" style="flex: 1;"></select>
            <button id="tpl-apply-btn" class="btn-small btn-primary" title="将此模板应用到当前角色">应用</button>
            <button id="tpl-export-btn" class="btn-small btn-secondary">导出</button>
            <button id="tpl-delete-btn" class="btn-small btn-secondary" style="color:var(--danger)" title="删除此模板">删除</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
            <button id="tpl-edit-btn" class="btn-small btn-secondary">设计选中模板</button>
            <button id="tpl-new-btn" class="btn-small btn-secondary">手动新建模板</button>
            <input type="file" id="template-import-file" accept=".json" style="display: none;">
            <button id="template-import-btn" class="btn-small btn-secondary" style="grid-column: span 2;">从文件导入模板 (.json)</button>
        </div>
      </div>

      <div class="settings-section">
        <input id="character-search" class="form-input" placeholder="搜索 ID 或名称...">
        <ul id="character-list" class="list" style="margin-top:10px;"></ul>
      </div>
    </section>

    <section class="right-panel">
      <div class="panel-header">
        <div class="panel-title" id="right-panel-title">角色详情</div>
        <div class="panel-header-right">
            <button id="character-export-single-btn" class="btn-small btn-secondary">导出当前角色</button>
            <button id="character-delete-btn" class="btn-small btn-secondary" style="color: var(--danger); margin-right: 10px;">删除角色</button>
            <div class="toggle-group" style="display: inline-flex; margin-right: 10px; border: 1px solid var(--border-color); border-radius: 4px;">
                <button id="view-mode-btn" class="btn-small active">预览</button>
                <button id="edit-mode-btn" class="btn-small">编辑</button>
            </div>
            <button id="character-save-btn" class="btn-primary">保存角色</button>
            <span id="character-status" class="small-text" style="margin-left: 10px;"></span>
        </div>
      </div>

      <div id="character-renderer" class="detail-panel rendered-view">
        <div class="placeholder-text" style="color: var(--text-secondary); padding: 20px;">请从左侧列表选择角色...</div>
      </div>

      <div id="character-editor" class="detail-panel" style="display: none;">
        <div class="settings-section half-grid">
          <div>
            <label class="form-label">角色编号 (ID)</label>
            <input id="f-char-id" class="form-input" placeholder="例如 NPC_001">
          </div>
          <div>
            <label class="form-label">角色类型</label>
            <select id="f-char-type" class="form-select">
              <option value="npc">NPC</option>
              <option value="protagonist">主角</option>
              <option value="major">重要角色</option>
            </select>
          </div>
        </div>
        <hr style="border: 0; border-top: 1px solid var(--border-soft); margin: 15px 0;">
        <div id="editor-tabs-nav" class="character-tabs"></div>
        <div id="editor-fields-container" style="margin-top: 10px;"></div>
      </div>
    </section>
  </main>

  <div id="template-designer-modal" class="modal-overlay" style="display: none;">
    <div class="modal-window">
      <div class="modal-header">
        <div style="display: flex; gap: 15px; align-items: center;">
          <span class="panel-title" style="color: var(--accent);">角色模板设计器</span>
          <input id="design-tpl-id" class="form-input" style="width: 140px;" placeholder="模板唯一ID">
          <input id="design-tpl-name" class="form-input" style="width: 200px;" placeholder="显示名称">
        </div>
        <div class="modal-header-right">
          <button id="save-template-btn" class="btn-primary">保存模板配置</button>
          <button id="close-designer-btn" class="btn-secondary">关闭</button>
        </div>
      </div>

      <div class="modal-body" style="display: grid; grid-template-columns: 280px 1fr; gap: 20px; padding: 0;">
        <div style="border-right: 1px solid var(--border-soft); padding: 20px; background: rgba(0,0,0,0.1);">
          <div class="section-inline-header" style="margin-bottom: 15px;">
            <span class="form-label" style="font-weight: bold;">1. 标签页 (Tabs)</span>
            <button id="design-add-tab-btn" class="btn-small-inline btn-secondary">+ 添加新标签</button>
          </div>
          <div id="design-tabs-container" style="display: flex; flex-direction: column; gap: 8px;"></div>
        </div>

        <div style="padding: 20px; overflow-y: auto;">
          <div class="section-inline-header" style="margin-bottom: 15px;">
            <span class="form-label" style="font-weight: bold;">2. 字段配置 (Fields)</span>
            <button id="design-add-field-btn" class="btn-small btn-secondary">+ 添加新字段</button>
          </div>
          <div id="design-fields-container" style="display: flex; flex-direction: column; gap: 12px;">
            </div>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/js/characters.js"></script>
</body>
</html>